@model XRayDiagnosticSystem.Models.XRay

@{
    ViewData["Title"] = "X-Ray Analysis Core";
}

<div class="row">
    <div class="col-md-7">
        <div class="glass-card fade-in h-100 p-0 overflow-hidden">
            <div class="bg-dark p-3 d-flex justify-content-between align-items-center">
                <span class="text-white fw-bold"><i class="fas fa-eye me-2"></i> Diagnostic Viewer</span>
                <span class="badge bg-primary">ID: @Model.XRayId</span>
            </div>
            <div class="p-4 text-center bg-black position-relative" style="min-height: 500px; display: flex; align-items: center; justify-content: center;">
                <img src="@Model.ImagePath" id="mainXray" class="img-fluid rounded shadow-lg border border-secondary" style="max-height: 450px;" alt="X-Ray Scan" />
                <div id="neuralScanner" class="position-absolute w-100 h-100 d-none" style="top:0; left:0; background: rgba(27, 255, 255, 0.05); pointer-events: none;">
                    <div class="scan-line" style="position: absolute; width: 100%; height: 2px; background: cyan; animation: scanMove 3s infinite linear;"></div>
                </div>
            </div>
            <div class="p-3 bg-light border-top">
                <p class="mb-0 small text-muted"><strong>Notes:</strong> @Model.TechnicianNotes</p>
            </div>
        </div>
    </div>

    <div class="col-md-5">
        <div class="glass-card fade-in h-100">
            <h4 class="fw-bold mb-4">Diagnostic Processing</h4>
            
            <div class="patient-snippet mb-4 p-3 rounded-3 bg-soft-blue d-flex justify-content-between align-items-center" style="background: rgba(46, 49, 146, 0.05);">
                <div>
                    <div class="small text-muted text-uppercase fw-bold">Patient</div>
                    <div class="h5 fw-bold text-primary mb-0">@Model.PatientName</div>
                </div>
                <button type="button" class="btn btn-sm btn-dark rounded-pill" onclick="triggerAIScan()">
                    <i class="fas fa-robot me-1"></i> AI SCAN
                </button>
            </div>

            <!-- AI Insight Section -->
            <div id="aiInsights" class="mb-4 glass-card p-3 border-cyan d-none" style="border: 1px solid cyan; background: rgba(27, 255, 255, 0.05);">
                <h6 class="fw-bold text-info mb-3"><i class="fas fa-brain me-2"></i> Neural Prediction Engine</h6>
                <div class="list-group list-group-flush bg-transparent">
                    @foreach (var pred in ViewBag.MLResults)
                    {
                        <div class="list-group-item bg-transparent border-0 p-1 small d-flex justify-content-between">
                            <span class="text-dark fw-bold">@pred.Label</span>
                            <span class="text-info">@(pred.Probability * 100)%</span>
                        </div>
                    }
                </div>
            </div>

            <form asp-action="ProcessAnalysis" method="post">
                <input type="hidden" name="xRayId" value="@Model.XRayId" />
                
                <div class="mb-4">
                    <label class="form-label fw-bold">Observations (Tags)</label>
                    <p class="small text-muted">Select or type findings observed in the scan (comma separated).</p>
                    <input type="text" name="tagsString" id="tagsInput" class="form-control p-3 rounded-3" placeholder="e.g., Cloudy, Fluid, Fracture" required />
                    <div class="mt-3">
                        <span class="badge bg-light text-dark p-2 me-1 pointer" onclick="addTag('Cloudy')">+ Cloudy</span>
                        <span class="badge bg-light text-dark p-2 me-1 pointer" onclick="addTag('Fluid')">+ Fluid</span>
                        <span class="badge bg-light text-dark p-2 me-1 pointer" onclick="addTag('Fracture')">+ Fracture</span>
                        <span class="badge bg-light text-dark p-2 me-1 pointer" onclick="addTag('Clear')">+ Clear</span>
                    </div>
                </div>

                <div class="alert alert-info border-0 shadow-sm rounded-4">
                    <div class="d-flex">
                        <i class="fas fa-info-circle fa-lg me-3 mt-1"></i>
                        <div>
                            <strong>Rule Engine Protocol</strong>
                            <p class="mb-0 small">Entering tags will trigger the internal diagnostic logic to suggest potential medical conditions.</p>
                        </div>
                    </div>
                </div>

                <div class="mt-5 d-grid">
                    <button type="submit" class="btn btn-premium py-3 fs-5 shadow">
                        <i class="fas fa-microchip me-2"></i> Run Rule Engine
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function triggerAIScan() {
            const scanner = document.getElementById('neuralScanner');
            const insight = document.getElementById('aiInsights');
            scanner.classList.remove('d-none');
            
            setTimeout(() => {
                scanner.classList.add('d-none');
                insight.classList.remove('d-none');
                insight.classList.add('fade-in');
            }, 3000);
        }

        function addTag(tag) {
            const input = document.getElementById('tagsInput');
            let current = input.value.trim();
            if (current) {
                if (!current.toLowerCase().includes(tag.toLowerCase())) {
                    input.value = current + ', ' + tag;
                }
            } else {
                input.value = tag;
            }
        }
    </script>
    <style>
        .pointer { cursor: pointer; transition: 0.2s; }
        .pointer:hover { background: #2E3192 !important; color: white !important; }
        .border-cyan { border-color: #1BFFFF !important; }
        
        @@keyframes scanMove {
            0% { top: 0; opacity: 0; }
            50% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }
    </style>
}
